<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.53">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>unit_tests – Tergite Automatic Calibration</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


    <script src="../site_libs/quarto-nav/quarto-nav.js"></script>
    <script src="../site_libs/quarto-nav/headroom.min.js"></script>
    <script src="../site_libs/clipboard/clipboard.min.js"></script>
    <script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
    <script src="../site_libs/quarto-search/fuse.min.js"></script>
    <script src="../site_libs/quarto-search/quarto-search.js"></script>
    <meta name="quarto:offset" content="../">
    <script src="../site_libs/quarto-html/quarto.js"></script>
    <script src="../site_libs/quarto-html/popper.min.js"></script>
    <script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
    <script src="../site_libs/quarto-html/anchor.min.js"></script>
    <link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
    <link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme"
          id="quarto-text-highlighting-styles">
    <link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch"
          class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
    <script src="../site_libs/bootstrap/bootstrap.min.js"></script>
    <link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
    <link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme"
          id="quarto-bootstrap" data-mode="light">
    <link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch"
          class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
    "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
    "panel-placement": "start",
    "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
          <a class="navbar-brand" href="../">
    <span class="navbar-title">Tergite Automatic Calibration</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
      <a class="nav-link active" href="../index.html" aria-current="page">
          <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
      <a class="nav-link" href="../getting_started.html">
          <span class="menu-text">User Guide</span></a>
  </li>  
  <li class="nav-item">
      <a class="nav-link" href="../available_nodes.html">
          <span class="menu-text">Node Library</span></a>
  </li>  
  <li class="nav-item">
      <a class="nav-link" href="../developer_guide.html">
      <span class="menu-text">Developer Guide</span></a>
  </li>  
  <li class="nav-item">
      <a class="nav-link" href="../troubleshooting.html">
          <span class="menu-text">Troubleshooting</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
                <a href="https://github.com/tergite/tergite-autocalibration" title=""
                   class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
                <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1"
                   onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
      <nav class="quarto-secondary-nav">
          <div class="container-fluid d-flex">
              <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button"
                      data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar"
                      aria-expanded="false" aria-label="Toggle sidebar navigation"
                      onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
                  <i class="bi bi-layout-text-sidebar-reverse"></i>
              </button>
              <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb">
                  <ol class="breadcrumb">
                      <li class="breadcrumb-item"><a href="../developer_guide.html">Developer Guide</a></li>
                      <li class="breadcrumb-item"><a href="../developer-guide/unit_tests.html">Unit tests</a></li>
                  </ol>
              </nav>
              <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse"
                 data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false"
                 aria-label="Toggle sidebar navigation"
                 onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
              </a>
              <button type="button" class="btn quarto-search-button" aria-label="Search"
                      onclick="window.quartoOpenSearch();">
                  <i class="bi bi-search"></i>
              </button>
          </div>
      </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
    <nav id="quarto-sidebar"
         class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
            <div class="sidebar-search">
                <div id="quarto-search" class="" title="Search"></div>
            </div>
        </div>
        <div class="sidebar-menu-container">
            <ul class="list-unstyled mt-1">
                <li class="sidebar-item">
                    <div class="sidebar-item-container">
                        <a href="../index.html" class="sidebar-item-text sidebar-link">
                            <span class="menu-text">Home</span></a>
                    </div>
                </li>
                <li class="sidebar-item sidebar-item-section">
                    <div class="sidebar-item-container">
                        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse"
                           data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
                            <span class="menu-text">User Guide</span></a>
                        <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse"
                           data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true"
                           aria-label="Toggle section">
                            <i class="bi bi-chevron-right ms-2"></i>
                        </a>
                    </div>
                    <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
                        <li class="sidebar-item">
                            <div class="sidebar-item-container">
                                <a href="../getting_started.html" class="sidebar-item-text sidebar-link">
                                    <span class="menu-text">Getting started</span></a>
                            </div>
                        </li>
                        <li class="sidebar-item">
                            <div class="sidebar-item-container">
                                <a href="../user-guide/configuration_files.html" class="sidebar-item-text sidebar-link">
                                    <span class="menu-text">Configuration Files</span></a>
                            </div>
                        </li>
                        <li class="sidebar-item">
                            <div class="sidebar-item-container">
                                <a href="../user-guide/operation.html" class="sidebar-item-text sidebar-link">
                                    <span class="menu-text">Operation</span></a>
                            </div>
                        </li>
                    </ul>
                </li>
                <li class="sidebar-item sidebar-item-section">
                    <div class="sidebar-item-container">
                        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse"
                           data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
                            <span class="menu-text">Node Library</span></a>
                        <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse"
                           data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true"
                           aria-label="Toggle section">
                            <i class="bi bi-chevron-right ms-2"></i>
                        </a>
                    </div>
                    <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
                        <li class="sidebar-item">
                            <div class="sidebar-item-container">
                                <a href="../available_nodes.html" class="sidebar-item-text sidebar-link">
                                    <span class="menu-text">Overview</span></a>
                            </div>
                        </li>
                        <li class="sidebar-item">
                            <div class="sidebar-item-container">
                                <a href="../nodes/resonator_spectroscopy_node.html"
                                   class="sidebar-item-text sidebar-link">
                                    <span class="menu-text">Resonator spectroscopy</span></a>
                            </div>
                        </li>
                        <li class="sidebar-item">
                            <div class="sidebar-item-container">
                                <a href="../nodes/qubit_spectroscopy_node.html" class="sidebar-item-text sidebar-link">
                                    <span class="menu-text">Qubit spectroscopy</span></a>
                            </div>
                        </li>
                    </ul>
                </li>
                <li class="sidebar-item sidebar-item-section">
                    <div class="sidebar-item-container">
                        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse"
                           data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
                            <span class="menu-text">Developer Guide</span></a>
                        <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse"
                           data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true"
                           aria-label="Toggle section">
                            <i class="bi bi-chevron-right ms-2"></i>
                        </a>
                    </div>
                    <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
                        <li class="sidebar-item">
                            <div class="sidebar-item-container">
                                <a href="../developer_guide.html" class="sidebar-item-text sidebar-link">
                                    <span class="menu-text">Introduction</span></a>
                            </div>
                        </li>
                        <li class="sidebar-item">
                            <div class="sidebar-item-container">
                                <a href="../developer-guide/node_classes.html" class="sidebar-item-text sidebar-link">
                                    <span class="menu-text">Node Classes</span></a>
                            </div>
                        </li>
                        <li class="sidebar-item">
                            <div class="sidebar-item-container">
                                <a href="../developer-guide/new_node_creation.html"
                                   class="sidebar-item-text sidebar-link">
                                    <span class="menu-text">Create a new node</span></a>
                            </div>
                        </li>
                        <li class="sidebar-item">
                            <div class="sidebar-item-container">
                                <a href="../developer-guide/unit_tests.html"
                                   class="sidebar-item-text sidebar-link active">
                                    <span class="menu-text">Unit tests</span></a>
                            </div>
                        </li>
                        <li class="sidebar-item">
                            <div class="sidebar-item-container">
                                <a href="../developer-guide/writing_documentation.html"
                                   class="sidebar-item-text sidebar-link">
                                    <span class="menu-text">Writing documentation</span></a>
                            </div>
                        </li>
                    </ul>
                </li>
                <li class="sidebar-item">
                    <div class="sidebar-item-container">
                        <a href="../troubleshooting.html" class="sidebar-item-text sidebar-link">
                            <span class="menu-text">Troubleshooting</span></a>
                    </div>
                </li>
            </ul>
        </div>
    </nav>
    <div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse"
         data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
      <li><a href="#unit-tests" id="toc-unit-tests" class="nav-link active" data-scroll-target="#unit-tests">Unit
          tests</a>
          <ul class="collapse">
              <li><a href="#unit-tests-for-a-node" id="toc-unit-tests-for-a-node" class="nav-link"
                     data-scroll-target="#unit-tests-for-a-node">Unit tests for a node</a>
  <ul class="collapse">
  <li><a href="#folder-structure" id="toc-folder-structure" class="nav-link" data-scroll-target="#folder-structure">Folder structure</a></li>
      <li><a href="#general-information-about-testing-nodes" id="toc-general-information-about-testing-nodes"
             class="nav-link" data-scroll-target="#general-information-about-testing-nodes">General information about
          testing nodes</a></li>
      <li><a href="#example-tests" id="toc-example-tests" class="nav-link" data-scroll-target="#example-tests">Example
          Tests</a></li>
  </ul>
              </li>
              <li><a href="#advanced-topics-on-unit-tests" id="toc-advanced-topics-on-unit-tests" class="nav-link"
                     data-scroll-target="#advanced-topics-on-unit-tests">Advanced topics on unit tests</a>
  <ul class="collapse">
      <li><a href="#dealing-with-global-variables" id="toc-dealing-with-global-variables" class="nav-link"
             data-scroll-target="#dealing-with-global-variables">Dealing with global variables</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


    <section id="unit-tests" class="level1">
        <h1>Unit tests</h1>
        <p>When testing software, there are several ways to test whether it is working. Amongst others such as system
            integration tests or usability scores, there are unit tests. A unit test is meant to confirm whether a small
            unit of the code is working such as a function or a class. The idea behind unit tests though, is to create
            tiny little tests for each function, that checks how it handles:</p>
        <ul>
            <li><strong>Normal case</strong>: The things that you would expect a function to do e.g.&nbsp;if you have
                addition, and you add natural numbers.
            </li>
            <li><strong>Edge cases</strong>: In the example with the addition this would be e.g.&nbsp;whether it
                correctly adds zero or would subtract if there is a negative number.
            </li>
            <li><strong>Fail cases</strong>: Let us say you have addition, and you are adding a number such as 20 with
                the string “hello”. This should fail.
            </li>
        </ul>
        <p>Having thought about the test cases and possible scenarios will help to get a better understanding what the
            code does, also, it will make the code more robust. In our code base we are having a pipeline that will
            automatically run all tests as soon as someone wants to merge to the common branches. There are two
            locations where tests are stored:</p>
        <ul>
            <li><strong>In the folder for tests</strong>: This is a folder on the main level of the repository where
                more general tests for the whole framework go.
            </li>
            <li><strong>In the folder of each node</strong>: This is to test only the node itself. The tests are added
                directly to the node module.
            </li>
        </ul>
        <p>Since it happens more often that one will write tests for the node itself, in the following, there will be a
            section explaining how to do it on an example node.</p>
        <section id="unit-tests-for-a-node" class="level2">
            <h2 class="anchored" data-anchor-id="unit-tests-for-a-node">Unit tests for a node</h2>
            <p>These instructions will go step-by-step through how to create meaningful test cases for a node.</p>
            <ol type="1">
                <li>Overview about the folder structure</li>
                <li>Specific advices on how to test nodes</li>
                <li>Examples on how to test the analysis function of a node</li>
            </ol>
            <p>If you are more a person that learns from the code rather than from a tutorial, please take a look at an
                easy node e.g. resonator spectroscopy and try to run and understand the test cases.</p>
            <section id="folder-structure" class="level3">
                <h3 class="anchored" data-anchor-id="folder-structure">Folder structure</h3>
<p>The test should be created in a sub-folder of the node called tests.</p>
<p>Please organise the file using these sub-folders:</p>
<ul>
    <li><strong>data</strong>: place here any data file that is needed to create test cases, while it is possible to
        mock the data. Feel free to add a text file explaining how the data was produced.Mocking data is also possible,
        but it may be not practical for complex datasets.
    </li>
    <li><strong>results</strong>: create this folder to store your results, i.e.&nbsp;files that would be created by
        your analysis such as the plots. It should be empty, do not commit your results. To assure this is the case, add
        a file name .gitignore in the folder with this code:
    </li>
</ul>
                <pre class="gitignore"><code># Ignore everything in this directory
*

# But do not ignore this file
!.gitignore     </code></pre>
</section>
            <section id="general-information-about-testing-nodes" class="level3">
                <h3 class="anchored" data-anchor-id="general-information-about-testing-nodes">General information about
                    testing nodes</h3>
                <p>A good starting point, especially starting from scratch, it is to test for the class type, then that
                    the inputs have the right formats and then move to some simple operation or trivial case. Build more
                    complex cases from the simpler ones and exploits your tests to refactor the code as needed. Try to
                    test as many reasonable cases as possible, both successfully and not. Remember to test for
                    exceptions. We also suggest to develop using test drive development techniques that will ensure a
                    high test coverage and a good code structure. Yes, do not forget to keep refactoring to improve the
                    code.</p>
<p>You can find some samples below taken from the cz_parametrisation node, where all objects are tested</p>
                <p>Currently, there is no way to differentiate from tests that require a QPU (i.e.&nbsp;measurements)
                    and those that do not ( i.e.&nbsp;analyses). Since the latter are simpler to write, start with those
                    that, in general, are more likely to benefit from unit tests as there is much more logic in the
                    analysis than in the measurement.</p>
                <p>If you need to test some complex scenario, such as those involving sweep, it is probably easier to
                    start writing code and tests from the lowest level and then compose those objects to handle the more
                    complex scenario considered.</p>
</section>
            <section id="example-tests" class="level3">
                <h3 class="anchored" data-anchor-id="example-tests">Example Tests</h3>
                <p><strong>Test class type</strong></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_canCreateCorrectType():</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  c <span class="op">=</span> CZ_Parametrization_Fix_Duration_Node(<span
        class="st">"cz_char_fixCurrent"</span>, couplers<span class="op">=</span>[<span
        class="st">"q14_q15"</span>])</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span
        class="bu">isinstance</span>(c, CZ_Parametrization_Fix_Duration_Node)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span
        class="bu">isinstance</span>(c, ScheduleNode)</span></code><button title="Copy to Clipboard"
                                                                           class="code-copy-button"><i
        class="bi"></i></button></pre>
</div>
                <p>The suggested very first test is to instantiate the class and make sure it has the correct type(s)
                    following any inheritance.</p>
                <p><strong>Test input parameters</strong></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_CanGetQubitsFromCouplers():</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  c <span class="op">=</span> CZ_Parametrization_Fix_Duration_Node(<span
        class="st">"cz_char_fixCurrent"</span>, couplers<span class="op">=</span>[<span
        class="st">"q14_q15"</span>])</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> c.all_qubits <span class="op">==</span> [<span class="st">"q14"</span>, <span class="st">"q15"</span>]</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> c.couplers <span class="op">==</span> [<span class="st">'q14_q15'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Make sure all inputs and their manipulations are correctly initialised in the constructor, in this case the qubits are taken from the coupler pair</p>
                <p><strong>Test exception</strong></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_ValidationReturnErrorWithSameQubitCoupler():</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pytest.raises(<span class="pp">ValueError</span>):</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>      CZ_Parametrization_Fix_Duration_Node(<span
        class="st">"cz_char_fixCurrent"</span>, couplers<span class="op">=</span>[<span
        class="st">"q14_q14"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i
        class="bi"></i></button></pre>
</div>
<p>Inputs can be incorrect and should always be tested to avoid unexpected behaviour down the line which can be difficult to trace back to the origin. There are infinite number of possible errors, so it is impossible to cover them all, but at least the obvious ones should be considered. In this case a typical typing error with the couple have the same qubit twice.</p>
                <p><strong>Test with data</strong></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.fixture</span>(autouse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_good_data():</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    os.environ[<span class="st">"DATA_DIR"</span>] <span class="op">=</span> <span class="bu">str</span>(Path(<span class="va">__file__</span>).parent <span class="op">/</span> <span class="st">"results"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    dataset_path <span class="op">=</span> Path(<span class="va">__file__</span>).parent <span class="op">/</span> <span class="st">"data"</span> <span class="op">/</span> <span class="st">"dataset_good_quality_freq_amp.hdf5"</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(dataset_path)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(dataset_path)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    ds <span class="op">=</span> ds.isel(ReIm<span class="op">=</span><span class="dv">0</span>) <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> ds.isel(ReIm<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    d14 <span class="op">=</span> ds.yq14.to_dataset()</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    d15 <span class="op">=</span> ds.yq15.to_dataset()</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    d14.yq14.attrs[<span class="st">"qubit"</span>] <span class="op">=</span> <span class="st">"q14"</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    d15.yq15.attrs[<span class="st">"qubit"</span>] <span class="op">=</span> <span class="st">"q15"</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    freqs <span class="op">=</span> ds[<span class="ss">f"cz_pulse_frequenciesq14_q15"</span>].values  <span class="co"># MHz</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    amps <span class="op">=</span> ds[<span class="ss">f"cz_pulse_amplitudesq14_q15"</span>].values  <span class="co"># uA</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> d14, d15, freqs, amps</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is an example of how to load data for testing the analysis of a node, please note that the specifics may change as we are about to change the dataset format at the time of writing this; however, the principle will be the same.</p>
<p>This data can then be used in multiple tests, for example:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_canGetMaxFromQ1(setup_good_data):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    d14, d15, freqs, amps <span class="op">=</span> setup_good_data</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> CZ_Parametrisation_Frequency_vs_Amplitude_Q1_Analysis(d14, freqs, amps)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> c.run_fitting()</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    indexBestFreq <span class="op">=</span> np.where(freqs <span class="op">==</span> result[<span class="dv">0</span>])[<span class="dv">0</span>]</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    indexBestAmp <span class="op">=</span> np.where(amps <span class="op">==</span> result[<span class="dv">1</span>])[<span class="dv">0</span>]</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> indexBestFreq[<span class="dv">0</span>] <span class="op">==</span> <span class="dv">9</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> indexBestAmp[<span class="dv">0</span>] <span class="op">==</span> <span class="dv">13</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_canGetMinFromQ2(setup_good_data):</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    d14, d15, freqs, amps <span class="op">=</span> setup_good_data</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> CZ_Parametrisation_Frequency_vs_Amplitude_Q2_Analysis(d15, freqs, amps)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> c.run_fitting()</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    indexBestFreq <span class="op">=</span> np.where(freqs <span class="op">==</span> result[<span class="dv">0</span>])[<span class="dv">0</span>]</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    indexBestAmp <span class="op">=</span> np.where(amps <span class="op">==</span> result[<span class="dv">1</span>])[<span class="dv">0</span>]</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> indexBestFreq[<span class="dv">0</span>] <span class="op">==</span> <span class="dv">10</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> indexBestAmp[<span class="dv">0</span>] <span class="op">==</span> <span class="dv">12</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These two tests make sure that the return values are correct for the two qubits that are connected by the coupler.</p>
                <p><strong>Test creating of images from plotter</strong></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_canPlotBad(setup_bad_data):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    matplotlib.use(<span class="st">"Agg"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    d14, d15, freqs, amps <span class="op">=</span> setup_bad_data</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    c14 <span class="op">=</span> CZ_Parametrisation_Frequency_vs_Amplitude_Q1_Analysis(d14, freqs, amps)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> c14.run_fitting()</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    figure_path <span class="op">=</span> os.environ[<span class="st">"DATA_DIR"</span>] <span class="op">+</span> <span class="st">"/Frequency_Amplitude_bad_q14.png"</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove the file if it already exists</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(figure_path):</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        os.remove(figure_path)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">7</span>), num<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    plt.Axes</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    c14.plotter(ax)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    fig.savefig(figure_path)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> os.path.exists(figure_path)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> Image.<span class="bu">open</span>(figure_path) <span class="im">as</span> img:</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> img.<span class="bu">format</span> <span class="op">==</span> <span class="st">"PNG"</span>, <span class="st">"File should be a PNG image"</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    c15 <span class="op">=</span> CZ_Parametrisation_Frequency_vs_Amplitude_Q2_Analysis(d15, freqs, amps)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> c15.run_fitting()</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    figure_path <span class="op">=</span> os.environ[<span class="st">"DATA_DIR"</span>] <span class="op">+</span> <span class="st">"/Frequency_Amplitude_bad_q15.png"</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove the file if it already exists</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(figure_path):</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        os.remove(figure_path)</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">7</span>), num<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    plt.Axes</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    c15.plotter(ax)</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    fig.savefig(figure_path)</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> os.path.exists(figure_path)</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> Image.<span class="bu">open</span>(figure_path) <span class="im">as</span> img:</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> img.<span class="bu">format</span> <span class="op">==</span> <span class="st">"PNG"</span>, <span class="st">"File should be a PNG image"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is an example on how to save files in the “results” sub-folder within the “tests” folder. The code make sure the expected file exists and has the correct format. The created files can be inspected by the developer. A possible extension would be to upload the images in the data folder and check the those produced by the test are identical.</p>
                <p><strong>Complex dataset for comparing results</strong></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.fixture</span>(autouse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_bad_data():</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    dataset_path <span class="op">=</span> Path(<span class="va">__file__</span>).parent <span class="op">/</span> <span class="st">"data"</span> <span class="op">/</span> <span class="st">"dataset_bad_quality_freq_amp.hdf5"</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(dataset_path)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(dataset_path)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    ds <span class="op">=</span> ds.isel(ReIm<span class="op">=</span><span class="dv">0</span>) <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> ds.isel(ReIm<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    d14 <span class="op">=</span> ds.yq14.to_dataset()</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    d15 <span class="op">=</span> ds.yq15.to_dataset()</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    d14.yq14.attrs[<span class="st">"qubit"</span>] <span class="op">=</span> <span class="st">"q14"</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    d15.yq15.attrs[<span class="st">"qubit"</span>] <span class="op">=</span> <span class="st">"q15"</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    freqs <span class="op">=</span> ds[<span class="ss">f"cz_pulse_frequenciesq14_q15"</span>].values  <span class="co"># MHz</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    amps <span class="op">=</span> ds[<span class="ss">f"cz_pulse_amplitudesq14_q15"</span>].values  <span class="co"># uA</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    q14Ana <span class="op">=</span> CZ_Parametrisation_Frequency_vs_Amplitude_Q1_Analysis(d14, freqs, amps)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    q14Res <span class="op">=</span> q14Ana.run_fitting()</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    q15Ana <span class="op">=</span> CZ_Parametrisation_Frequency_vs_Amplitude_Q2_Analysis(d15, freqs, amps)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    q15Res <span class="op">=</span> q15Ana.run_fitting()</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> q14Res, q15Res</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_combineBadResultsReturnNoValidPoint(setup_bad_data):</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    q14Res, q15Res <span class="op">=</span> setup_bad_data</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> CZ_Parametrisation_Combined_Frequency_vs_Amplitude_Analysis(q14Res, q15Res)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> c.are_frequencies_compatible()</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> r <span class="op">==</span> <span class="va">False</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> c.are_amplitudes_compatible()</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> r <span class="op">==</span> <span class="va">False</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> c.are_two_qubits_compatible()</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> r <span class="op">==</span> <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this example, the data produced is loaded from a file that has data that is not a good working point. Note that there two analyses are run in the setup; the combination is run in the test, so that, if needed in other tests, the data could be modified for specific cases. This is a failure test, making sure that bad inputs are not recognised as good working points.</p>
                <p><strong>Even more complex setup</strong></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_data():</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># It should be a single dataset, but we do not have one yet, so we loop over existing files</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    dataset_path <span class="op">=</span> Path(<span class="va">__file__</span>).parent <span class="op">/</span> <span class="st">"data"</span> <span class="op">/</span> <span class="st">"dataset_good_quality_freq_amp.hdf5"</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(dataset_path)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(dataset_path)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    ds <span class="op">=</span> ds.isel(ReIm<span class="op">=</span><span class="dv">0</span>) <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> ds.isel(ReIm<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    d14 <span class="op">=</span> ds.yq14.to_dataset()</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    d15 <span class="op">=</span> ds.yq15.to_dataset()</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    d14.yq14.attrs[<span class="st">"qubit"</span>] <span class="op">=</span> <span class="st">"q14"</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    d15.yq15.attrs[<span class="st">"qubit"</span>] <span class="op">=</span> <span class="st">"q15"</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    freqs <span class="op">=</span> ds[<span class="ss">f"cz_pulse_frequenciesq14_q15"</span>].values  <span class="co"># MHz</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    amps <span class="op">=</span> ds[<span class="ss">f"cz_pulse_amplitudesq14_q15"</span>].values  <span class="co"># uA</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    q14Ana <span class="op">=</span> CZ_Parametrisation_Frequency_vs_Amplitude_Q1_Analysis(d14, freqs, amps)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    q14Res <span class="op">=</span> q14Ana.run_fitting()</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    q15Ana <span class="op">=</span> CZ_Parametrisation_Frequency_vs_Amplitude_Q2_Analysis(d15, freqs, amps)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    q15Res <span class="op">=</span> q15Ana.run_fitting()</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    c1 <span class="op">=</span> CZ_Parametrisation_Combined_Frequency_vs_Amplitude_Analysis(q14Res, q15Res)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    dataset_path <span class="op">=</span> Path(<span class="va">__file__</span>).parent <span class="op">/</span> <span class="st">"data"</span> <span class="op">/</span> <span class="st">"dataset_bad_quality_freq_amp.hdf5"</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(dataset_path)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(dataset_path)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    ds <span class="op">=</span> ds.isel(ReIm<span class="op">=</span><span class="dv">0</span>) <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> ds.isel(ReIm<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    d14 <span class="op">=</span> ds.yq14.to_dataset()</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    d15 <span class="op">=</span> ds.yq15.to_dataset()</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    d14.yq14.attrs[<span class="st">"qubit"</span>] <span class="op">=</span> <span class="st">"q14"</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    d15.yq15.attrs[<span class="st">"qubit"</span>] <span class="op">=</span> <span class="st">"q15"</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    freqs_bad <span class="op">=</span> ds[<span class="ss">f"cz_pulse_frequenciesq14_q15"</span>].values  <span class="co"># MHz</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    amps_bad <span class="op">=</span> ds[<span class="ss">f"cz_pulse_amplitudesq14_q15"</span>].values  <span class="co"># uA</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    q14Ana <span class="op">=</span> CZ_Parametrisation_Frequency_vs_Amplitude_Q1_Analysis(</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>        d14, freqs_bad, amps_bad</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    q14Res <span class="op">=</span> q14Ana.run_fitting()</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    q15Ana <span class="op">=</span> CZ_Parametrisation_Frequency_vs_Amplitude_Q2_Analysis(</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>        d15, freqs_bad, amps_bad</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    q15Res <span class="op">=</span> q15Ana.run_fitting()</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    c2 <span class="op">=</span> CZ_Parametrisation_Combined_Frequency_vs_Amplitude_Analysis(q14Res, q15Res)</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    dataset_path <span class="op">=</span> (</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>            Path(<span
        class="va">__file__</span>).parent <span class="op">/</span> <span class="st">"data"</span> <span
        class="op">/</span> <span class="st">"dataset_good_quality_freq_amp_2.hdf5"</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(dataset_path)</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(dataset_path)</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>    ds <span class="op">=</span> ds.isel(ReIm<span class="op">=</span><span class="dv">0</span>) <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> ds.isel(ReIm<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    d14 <span class="op">=</span> ds.yq14.to_dataset()</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    d15 <span class="op">=</span> ds.yq15.to_dataset()</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    d14.yq14.attrs[<span class="st">"qubit"</span>] <span class="op">=</span> <span class="st">"q14"</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    d15.yq15.attrs[<span class="st">"qubit"</span>] <span class="op">=</span> <span class="st">"q15"</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    freqs_2 <span class="op">=</span> ds[<span class="ss">f"cz_pulse_frequenciesq14_q15"</span>].values  <span class="co"># MHz</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    amps_2 <span class="op">=</span> ds[<span class="ss">f"cz_pulse_amplitudesq14_q15"</span>].values  <span class="co"># uA</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    q14Ana <span class="op">=</span> CZ_Parametrisation_Frequency_vs_Amplitude_Q1_Analysis(d14, freqs_2, amps_2)</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>    q14Res <span class="op">=</span> q14Ana.run_fitting()</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>    q15Ana <span class="op">=</span> CZ_Parametrisation_Frequency_vs_Amplitude_Q2_Analysis(d15, freqs_2, amps_2)</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>    q15Res <span class="op">=</span> q15Ana.run_fitting()</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    c3 <span class="op">=</span> CZ_Parametrisation_Combined_Frequency_vs_Amplitude_Analysis(q14Res, q15Res)</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    list_of_results <span class="op">=</span> [(c1, <span class="fl">0.1</span>), (c2, <span class="fl">0.2</span>), (c3, <span class="fl">0.3</span>)]</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> list_of_results, freqs, amps, freqs_2, amps_2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this case, three points are loaded and the analysis is run on each of them. The results are returned for each point and can be used in different tests, for example by removing elements in the list_results array.</p>
</section>
        </section>
        <section id="advanced-topics-on-unit-tests" class="level2">
            <h2 class="anchored" data-anchor-id="advanced-topics-on-unit-tests">Advanced topics on unit tests</h2>
            <p>When running unit tests, the test framework itself and the way tests are executed can cause problems that
                make the unit tests fail. Hence, it is important to understand how <code>pytest</code> works to get a
                grip on how to debug failing tests efficiently.</p>
            <p>In the beginning of each test run, <code>pytest</code> will try to import all necessary modules. If there
                are any “Unresolved reference” errors, the tests will even not start to run.</p>
            <section id="dealing-with-global-variables" class="level3">
                <h3 class="anchored" data-anchor-id="dealing-with-global-variables">Dealing with global variables</h3>
                <p>Tests might even indirectly affect the outcome of another test. As an example, there might be a test,
                    which changes some global state in the application. Let us say the default value for the global
                    variable <code>VAR_1</code> is 0, but one of the test changes sets the global variable
                    <code>VAR_1</code> to 1. Now, all following tests will read 1 when they get <code>VAR_1</code> from
                    the environment.</p>
                <p>Sometimes though, it might be necessary to change to global variable of one test. To handle these
                    situations, the test framework has implemented some decorators, which intend to freeze the
                    environment variables. The most simple way to freeze the state of the environment and then e.g.&nbsp;set
                    variables inside the test function is with the <code>@preserve_os_env</code> decorator.</p>
                <div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code
                        class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"
                                                                       tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tergite_autocalibration.tests.utils.decorators <span
        class="im">import</span> preserve_os_env</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="at">@preserve_os_env</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_my_function_that_sets_os_variables():</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  var1 <span
        class="op">=</span> os.environ[<span class="st">"VAR_1"</span>]  <span class="co"># VAR_1 = "0"</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  os.environ[<span
        class="st">"VAR_1"</span>] <span class="op">=</span> <span class="st">"1"</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  new_var1 <span class="op">=</span> os.environ[<span
        class="st">"VAR_1"</span>]</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">assert</span> <span
        class="bu">int</span>(var1) <span class="op">+</span> <span class="dv">1</span> <span class="op">==</span> <span
        class="bu">int</span>(new_var1)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_my_function_that_only_gets_os_variables():</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  var1 <span
        class="op">=</span> os.environ[<span class="st">"VAR_1"</span>]  <span class="co"># VAR_1 = "0"</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">assert</span> <span
        class="bu">int</span>(var1) <span class="op">==</span> <span class="dv">0</span></span></code><button
                        title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
                </div>
                <p>Here, if we had run the first test without the <code>@preserve_os_env</code> decorator, the second
                    test would fail, because the variable would be set to 1 in the first test and does not have the
                    default value 0.</p>
                <p>Another decorator in that regard is the <code>@with_os_env</code> decorator, which takes as an input
                    the dictionary of values that environment should hold. It is just a way that - similarly to a
                    fixture - simplifies the way things are set up without having too many <code>os.environ</code> calls
                    inside the code. For example, you want to change the value of an environmental variable in exactly
                    one test function, you can add:</p>
                <div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code
                        class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"
                                                                       tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tergite_autocalibration.tests.utils.decorators <span
        class="im">import</span> with_os_env</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="at">@with_os_env</span>({<span
        class="st">"VAR_1"</span>: <span class="st">"1"</span>})</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_my_function_that_needs_the_os_variables_changed():</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  var1 <span
        class="op">=</span> os.environ[<span class="st">"VAR_1"</span>]</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">assert</span> var1 <span
        class="op">==</span> <span class="st">"ABC"</span></span></code><button title="Copy to Clipboard"
                                                                                class="code-copy-button"><i
                        class="bi"></i></button></pre>
                </div>
                <p>This will freeze the current state of the environment, replace the variable <code>VAR_1</code> with
                    “ABC” and after the test will cleanup the environment and load the previous values.</p>


            </section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();
    const disableStylesheet = (stylesheets) => {
        for (let i = 0; i < stylesheets.length; i++) {
            const stylesheet = stylesheets[i];
            stylesheet.rel = 'prefetch';
        }
    }
    const enableStylesheet = (stylesheets) => {
        for (let i = 0; i < stylesheets.length; i++) {
            const stylesheet = stylesheets[i];
            stylesheet.rel = 'stylesheet';
        }
    }
    const manageTransitions = (selector, allowTransitions) => {
        const els = window.document.querySelectorAll(selector);
        for (let i = 0; i < els.length; i++) {
            const el = els[i];
            if (allowTransitions) {
                el.classList.remove('notransition');
            } else {
                el.classList.add('notransition');
            }
        }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
        const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
        const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
        let newTheme = '';
        if (darkModeDefault) {
            newTheme = isAlternate ? baseTheme : alternateTheme;
        } else {
            newTheme = isAlternate ? alternateTheme : baseTheme;
        }
        const changeGiscusTheme = () => {
            // From: https://github.com/giscus/giscus/issues/336
            const sendMessage = (message) => {
                const iframe = document.querySelector('iframe.giscus-frame');
                if (!iframe) return;
                iframe.contentWindow.postMessage({giscus: message}, 'https://giscus.app');
            }
            sendMessage({
                setConfig: {
                    theme: newTheme
                }
            });
        }
        const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
        if (isGiscussLoaded) {
            changeGiscusTheme();
        }
    }
    const toggleColorMode = (alternate) => {
        // Switch the stylesheets
        const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
        manageTransitions('#quarto-margin-sidebar .nav-link', false);
        if (alternate) {
            enableStylesheet(alternateStylesheets);
            for (const sheetNode of alternateStylesheets) {
                if (sheetNode.id === "quarto-bootstrap") {
                    toggleBodyColorMode(sheetNode);
                }
            }
        } else {
            disableStylesheet(alternateStylesheets);
            toggleBodyColorPrimary();
        }
        manageTransitions('#quarto-margin-sidebar .nav-link', true);
        // Switch the toggles
        const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
        for (let i = 0; i < toggles.length; i++) {
            const toggle = toggles[i];
            if (toggle) {
                if (alternate) {
                    toggle.classList.add("alternate");
                } else {
                    toggle.classList.remove("alternate");
                }
            }
        }
        // Hack to workaround the fact that safari doesn't
        // properly recolor the scrollbar when toggling (#1455)
        if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
            manageTransitions("body", false);
            window.scrollTo(0, 1);
            setTimeout(() => {
                window.scrollTo(0, 0);
                manageTransitions("body", true);
            }, 40);
        }
    }
    const isFileUrl = () => {
        return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
        let styleSentinel = getColorSchemeSentinel();
        if (styleSentinel !== null) {
            return styleSentinel === "alternate";
        } else {
            return false;
        }
    }
    const setStyleSentinel = (alternate) => {
        const value = alternate ? "alternate" : "default";
        if (!isFileUrl()) {
            window.localStorage.setItem("quarto-color-scheme", value);
        } else {
            localAlternateSentinel = value;
        }
    }
    const getColorSchemeSentinel = () => {
        if (!isFileUrl()) {
            const storageValue = window.localStorage.getItem("quarto-color-scheme");
            return storageValue != null ? storageValue : localAlternateSentinel;
        } else {
            return localAlternateSentinel;
        }
    }
    const darkModeDefault = false;
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
        // Read the current dark / light value
        let toAlternate = !hasAlternateSentinel();
        toggleColorMode(toAlternate);
        setStyleSentinel(toAlternate);
        toggleGiscusIfUsed(toAlternate, darkModeDefault);
    };
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
        const a = window.document.createElement('a');
        a.classList.add('top-right');
        a.classList.add('quarto-color-scheme-toggle');
        a.href = "";
        a.onclick = function () {
            try {
                window.quartoToggleColorScheme();
            } catch {
            }
            return false;
        };
        const i = window.document.createElement("i");
        i.classList.add('bi');
        a.appendChild(i);
        window.document.body.appendChild(a);
    }
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
        toggleColorMode(true);
    } else {
        toggleColorMode(false);
    }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>